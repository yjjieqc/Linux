#  网络编程

# 模型

## OSI七层模型

1.物理层：主要定义物理设备标准，如网线的接口类型、光纤的接口类型、各种传输介
质的传输速率等。它的主要作用是传输比特流(就是由1、0转化为电流强弱来进行传输，到
达目的地后再转化为1、0，也就是我们常说的数模转换与模数转换)。这一层的数据叫做比
特。
2.数据链路层：定义了如何让格式化数据以进行传输，以及如何让控制对物理介质的访
问。这一层通常还提供错误检测和纠正，以确保数据的可靠传输。
3.网络层：在位于不同地理位置的网络中的两个主机系统之间提供连接和路径选
择。Internet的发展使得从世界各站点访问信息的用户数大大增加，而网络层正是管理这种
连接的层。
4.传输层：定义了一些传输数据的协议和端口号(WWW端口80等)，如：TCP(传输控制协
议，传输效率低，可靠性强，用于传输可靠性要求高，数据量大的数据)，UDP(用户数据报
协议，与TCP特性恰恰相反，用于传输可靠性要求不高，数据量小的数据，如QQ聊天数据就
是通过这种方式传输的）。 主要是将从下层接收的数据进行分段和传输，到达目的地址后
再进行重组。常常把这一层数据叫做段。
5.会话层：通过传输层(端口号：传输端口与接收端口)建立数据传输的通路。主要在你的系统之间发起会话或者接受会话请求(设备之间需要互相认识可以是IP也可以是MAC或者是
主机名)。
6.表示层：可确保一个系统的应用层所发送的信息可以被另一个系统的应用层读取。
例如，PC程序与另一台计算机进行通信，其中一台计算机使用扩展二一十进制交换码
(EBCDIC)，而另一台则使用美国信息交换标准码（ASCII）来表示相同的字符。如有必要，
表示层会通过使用一种通格式来实现多种数据格式之间的转换。
7.应用层：是最靠近用户的OSI层。这一层为用户的应用程序(例如电子邮件、文件传输
和终端仿真)提供网络服务。

###  TCP/IP四层模型

一般开发程序员讨论最多的是TCP/IP模型

##  通信过程

上图对应两台计算机在同一网段中的情况，如果两台计算机在不同的网段中，那么数据
从一台计算机到另一台计算机传输过程中要经过一个或多个路由器，如下图所示

其实在链路层之下还有物理层，指的是电信号的传递方式，比如现在以太网通用的网线
（双绞线）、早期以太网采用的的同轴电缆（现在主要用于有线电视）、光纤等都属于物理
层的概念。物理层的能力决定了最大传输速率、传输距离、抗干扰性等。集线器（Hub）是
工作在物理层的网络设备，用于双绞线的连接和信号中继（将已衰减的信号再次放大使之传
得更远）。

链路层有以太网、令牌环网等标准，链路层负责网卡设备的驱动、帧同步（就是说从网
线上检测到什么信号算作新帧的开始）、冲突检测（如果检测到冲突就自动重发）、数据差
错校验等工作。交换机是工作在链路层的网络设备，可以在不同的链路层网络之间转发数据
帧（比如十兆以太网和百兆以太网之间、以太网和令牌环网之间），由于不同链路层的帧格
式不同，交换机要将进来的数据包拆掉链路层首部重新封装之后再转发。
网络层的IP协议是构成Internet的基础。Internet上的主机通过IP地址来标识，Internet上有大量路由器负责根据IP地址选择合适的路径转发数据包，数据包从Internet上的源
主机到目的主机往往要经过十多个路由器。路由器是工作在第三层的网络设备，同时兼有交
换机的功能，可以在不同的链路层接口之间转发数据包，因此路由器需要将进来的数据包拆
掉网络层和链路层两层首部并重新封装。IP协议不保证传输的可靠性，数据包在传输过程中
可能丢失，可靠性可以在上层协议或应用程序中提供支持。
网络层负责点到点（point-to-point）的传输（这里的“点”指主机或路由器），而传
输层负责端到端（end-to-end）的传输（这里的“端”指源主机和目的主机）。传输层可选
择TCP或UDP协议。TCP是一种面向连接的、可靠的协议，有点像打电话，双方拿起电话互通
身份之后就建立了连接，然后说话就行了，这边说的话那边保证听得到，并且是按说话的顺
序听到的，说完话挂机断开连接。也就是说TCP传输的双方需要首先建立连接，之后由TCP协
议保证数据收发的可靠性，丢失的数据包自动重发，上层应用程序收到的总是可靠的数据
流，通讯之后关闭连接。UDP协议不面向连接，也不保证可靠性，有点像寄信，写好信放到
邮筒里，既不能保证信件在邮递过程中不会丢失，也不能保证信件是按顺序寄到目的地的。
使用UDP协议的应用程序需要自己完成丢包重发、消息排序等工作。
目的主机收到数据包后，如何经过各层协议栈最后到达应用程序呢？整个过程如下图所
示
以太网驱动程序首先根据以太网首部中的“上层协议”字段确定该数据帧的有效载荷
（payload，指除去协议首部之外实际传输的数据）是IP、ARP还是RARP协议的数据报，然后
交给相应的协议处理。假如是IP数据报，IP协议再根据IP首部中的“上层协议”字段确定该
数据报的有效载荷是TCP、UDP、ICMP还是IGMP，然后交给相应的协议处理。假如是TCP段或
UDP段，TCP或UDP协议再根据TCP首部或UDP首部的“端口号”字段确定应该将应用层数据交
给哪个用户进程。IP地址是标识网络中不同主机的地址，而端口号就是同一台主机上标识不
同进程的地址，IP地址和端口号合起来标识网络中唯一的进程。
注意，虽然IP、ARP和RARP数据报都需要以太网驱动程序来封装成帧，但是从功能上划
分，ARP和RARP属于链路层，IP属于网络层。虽然ICMP、IGMP、TCP、UDP的数据都需要IP协
议来封装成数据报，但是从功能上划分，ICMP、IGMP与IP同属于网络层，TCP和UDP属于传输层。本文对RARP、ICMP、IGMP协议不做进一步介绍，有兴趣的读者可以看参考资料。

##    协议格式

###  数据包封装

传输层及其以下的机制由内核提供，应用层由用户进程提供（后面将介绍如何使用
socket API编写应用程序），应用程序对通讯数据的含义进行解释，而传输层及其以下
处理通讯的细节，将数据从一台计算机通过一定的路径发送到另一台计算机。应用层
数据通过协议栈发到网络上时，每层协议都要加上一个数据首部（header），称为封装
（Encapsulation），如下图所示

不同的协议层对数据包有不同的称谓，在传输层叫做段（segment），在网络层叫做数
据报（datagram），在链路层叫做帧（frame）。数据封装成帧后发到传输介质上，到达目
的主机后每层协议再剥掉相应的首部，最后将应用层数据交给应用程序处理。

###  以太网帧格式

其中的源地址和目的地址是指网卡的硬件地址（也叫MAC地址），长度是48位，是在网
卡出厂时固化的。用ifconfig命令看一下，“HWaddr 00:15:F2:14:9E:3F”部分就是硬件地
址。协议字段有三种值，分别对应IP、ARP、RARP。帧末尾是CRC校验码。

以太网帧中的数据长度规定最小46字节，最大1500字节，ARP和RARP数据包的长度不够
46字节，要在后面补填充位。最大值1500称为以太网的最大传输单元（MTU），不同的网络
类型有不同的MTU，如果一个数据包从以太网路由到拨号链路上，数据包长度大于拨号链路
的MTU了，则需要对数据包进行分片（fragmentation）。ifconfig命令的输出中也有“MTU:
1500”。注意，MTU这个概念指数据帧中有效载荷的最大长度，不包括帧首部的长度。

###  ARP数据报格式

在网络通讯时，源主机的应用程序知道目的主机的IP地址和端口号，却不知道目的主机
的硬件地址，而数据包首先是被网卡接收到再去处理上层协议的，如果接收到的数据包的
硬件地址与本机不符，则直接丢弃。因此在通讯前必须获得目的主机的硬件地址。ARP协议
就起到这个作用。源主机发出ARP请求，询问“IP地址是192.168.0.1的主机的硬件地址是多
少”，并将这个请求广播到本地网段（以太网帧首部的硬件地址填FF:FF:FF:FF:FF:FF表示
广播），目的主机接收到广播的ARP请求，发现其中的IP地址与本机相符，则发送一个ARP应
答数据包给源主机，将自己的硬件地址填写在应答包中。
每台主机都维护一个ARP缓存表，可以用arp -a命令查看。缓存表中的表项有过期时间
（一般为20分钟），如果20分钟内没有再次使用某个表项，则该表项失效，下次还要发ARP
请求来获得目的主机的硬件地址。想一想，为什么表项要有过期时间而不是一直有效？
ARP数据报的格式如下所示


