## 第二章 内存寻址

### 2.1 引言

本章介绍寻址技术。值得庆幸的是，操作系统自身不必完全了解物理内存；如今的微处理器包含的硬件线路使内存管理既高效又健壮，所以变成错误就不会对该程序之外的内存产生非法访问。

作为本书的一部分，本章描述80x86微处理器怎样进行芯片级的内存寻址，Linux又是怎么利用寻址硬件的。

关于内存管理有三个部分，这是其中一章，此外还有讨论内核如何给自己分配内存，怎么给进程分配线性地址。

### 2.2 内存地址

程序员偶尔会用到引用内存地址作为访问内存单元内容的一种方式，但是，当使用80x86微处理器时，我们必须区分一下三种不同的地址：

* 逻辑地址（logical address）：包含在机器语言指令中用来指定一个操作数或者一条指令的地址。这种寻址方式在80x86的分段结构中表现的尤为具体，它促使MS-DOS或Windows程序员把程序分成若干段。每一个逻辑地址都由一个段（segment）和偏移量（offset或者displacement）组成，偏移量指明了从段开始的地方到实际地之间的距离。
* 线性地址（linear address）（也称虚拟地址 virtual address）：是一个32位无符号整数，可以用来表示高达4GB的地址，也就是，高达4294967296个内存单元。线性地址通常用十六进制数字表示，值的范围从0x00000000到0xffffffff。
* 物理地址（physical address）：用于内存芯片级内存单元寻址。他们从微处理器的地址引脚发送到内存总线上的电信号相对应。物理地址由32位或者64位无符号整数表示。

内存控制单元（MMU）通过一种称为分段单元（segmentation unit）的硬件电路把一个逻辑地址转换成线性地址；接着，第二个称为分页单元的硬件电路吧线性地址转换成一个物理地址。



## 2.5 硬件中的分页

分页单元（paging unit）把线性地址转化成物理地址。其中一个关键人物是把所请求的访问类型与线性地址的访问权限相比较，如果这次内存访问时无效的，就产生一次缺页异常。

为了效率起见，线性地址被分成固定长度为单位的组，称为页。页内部连续的线性地址被映射到连续的物理地址中。这样，内核可以指定一个页的物理地址和其存取权限，而不用指定页所包含的全部线性地址的存取权限。我们遵循通常习惯，使用术语页既指一组线性地址，又指包含在这组地址中的数据。

分页单元把所有的RAM分成固定长度的页框（page frame）（有时也叫物理页）。每个页框包含一个页，也就是说一个页框的长度与一个页的长度一致。页框是主存的一部分，因此也是一个储存区域。区分一页和一个页框是很重要的，前者只是一个数据块，也可以存放在任何页框或磁盘中。

把线性地址映射到物理地址的数据结构称为页表（page table）。页表存放在主存中，并在启用分页单元之前必须由内核对页表进行适当的初始化。

从80386开始，所有的80x86处理器都支持分页，它通过设置cr0寄存器的PG标志启用。当PG=0时，线性地址就被解释成物理地址。